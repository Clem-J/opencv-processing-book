<html>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script>
var data = {"title":"BrightnessTracking.pde","results":[{"code":"import gab.opencvpro.*;\n\nOpenCV opencv;\n\nvoid setup() {\n  opencv = new OpenCV(this, \"flashlight.jpg\");  \n  size(opencv.width, opencv.height, P2D);\n}\n\nvoid draw() {\n  image(opencv.getOutput(), 0, 0); \n}","illustration_embed":"<a href=\"http://www.flickr.com/photos/unavoidablegrain/9225754686/\" title=\"image1 by atduskgreg, on Flickr\"><img src=\"http://farm4.staticflickr.com/3760/9225754686_8cb205c73d.jpg\" width=\"500\" height=\"358\" alt=\"image1\"></a>","comments":["We start with a still image as a test.", "This is OpenCV hello world: load the image in, and display it.", "Note that OpenCV for Processing converts the image to grayscale by default."]},{"code":"import gab.opencvpro.*;\n\nOpenCV opencv;\n\nvoid setup() {\n  opencv = new OpenCV(this, \"flashlight.jpg\");  \n  size(opencv.width, opencv.height, P2D);\n}\n\nvoid draw() {\n  image(opencv.getOutput(), 0, 0); \n  PVector brightestPoint = opencv.max();\n  \n  noStroke();\n  fill(255, 0, 0);\n  ellipse(brightestPoint.x, brightestPoint.y, 20, 20);\n}","illustration_embed":"<a href=\"http://www.flickr.com/photos/unavoidablegrain/9225754450/\" title=\"image2 by atduskgreg, on Flickr\"><img src=\"http://farm6.staticflickr.com/5491/9225754450_a8780f2c74.jpg\" width=\"500\" height=\"358\" alt=\"image2\"></a>","comments":["Call <code>opencv.max()</code> to find the location of the brightest point in the iamge.","We then display that x-y location with a red ellipse."]},{"code":"import gab.opencvpro.*;\nimport processing.video.*;\n\nCapture video;\nOpenCV opencv;\n\nvoid setup() {\n  video = new Capture(this, 1280, 720);\n  opencv = new OpenCV(this, video.width, video.height);  \n  size(opencv.width, opencv.height, P2D);\n  \n  video.start();\n}\n\nvoid draw() {\n  opencv.loadImage(video);\n  image(opencv.getOutput(), 0, 0); \n  PVector brightestPoint = opencv.max();\n  \n  noStroke();\n  fill(255, 0, 0);\n  ellipse(brightestPoint.x, brightestPoint.y, 20, 20);\n}\n\nvoid captureEvent(Capture c) {\n  c.read();\n}","illustration_embed":"<iframe src=\"http://player.vimeo.com/video/69805961\" width=\"500\" height=\"281\" frameborder=\"0\" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe> ","comments":["Add the processing video library and declare a Capture object","Intialize the Capture object with the width and height of our camera", "Set our OpenCV object to have the same dimensions as the input video" ,"Start video capture going.","Load the current frame of video into OpenCV.","Then the rest of the sketch proceeds as before: show the grayscale image, find the max, draw a red ellipse on top of it."]},{"code":"import gab.opencvpro.*;\nimport processing.video.*;\n\nCapture video;\nOpenCV opencv;\n\nvoid setup() {\n  video = new Capture(this, 1280, 720);\n  opencv = new OpenCV(this, video.width, video.height);  \n  size(opencv.width, opencv.height, P2D);\n  \n  video.start();\n}\n\nvoid draw() {\n  opencv.loadImage(video);\n  opencv.setBufferGray(opencv.getBufferG());\n  image(opencv.getOutput(), 0, 0); \n  PVector brightestPoint = opencv.min();\n  \n  noStroke();\n  fill(255, 0, 0);\n  ellipse(brightestPoint.x, brightestPoint.y, 20, 20);\n}\n\nvoid captureEvent(Capture c) {\n  c.read();\n}","illustration_embed":"<iframe src=\"http://player.vimeo.com/video/69811466\" width=\"500\" height=\"281\" frameborder=\"0\" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>","comments":["Access the green channel and set it to be the gray buffer so that the following OpenCV operations will apply to it.", "Find the <code>max()</code> of the green channel. Brighter parts of the color channels represent more intense areas of green."]}]};

$(window).load(function () {

	$("#widgetTitle h3").html(data.title);
	var imgDiv = $("<div>");
	imgDiv.attr("id", "widgetImage");
	// imgDiv.append("<img>");

	var codeDiv = $("<div>");
	codeDiv.attr("id", "codeZone");

	var scriptTag = $("<pre>");
	codeDiv.append(scriptTag);

	var commentsDiv = $("<div>");
	commentsDiv.attr("id", "codeComments");
	var commentsList = $("<ul>");
	
	commentsDiv.append(commentsList);

	$("#widgetBody").prepend(commentsDiv);
	$("#widgetBody").prepend(codeDiv);
	$("#widgetBody").prepend(imgDiv);

	var currentVersion = 0;
	var numVersions = data.results.length;

	var updateProgress = function(){
		$("#progress").html((currentVersion+1) + "/" + numVersions);
	};

	var updateLinks = function(){
		$("#next").show();
		$("#previous").show();

		if(currentVersion >= (numVersions - 1)){
			$("#next").hide();
		}

		if(currentVersion === 0){
			$("#previous").hide();
		}

		updateProgress();
	};

	var updateBody = function(){
		$("#widgetImage").html(data.results[currentVersion].illustration_embed);
		$("#widgetBody pre").html(data.results[currentVersion].code);
			
		$("#codeComments ul").empty();
		for(var i = 0; i < data.results[currentVersion].comments.length; i++){
			var comment = $("<li>")
			comment.html(data.results[currentVersion].comments[i]);
			commentsList.append(comment);
		}
	}

	updateProgress();
	updateLinks();
	updateBody();

	$("#next").click(function(){
		currentVersion = currentVersion + 1;
		updateLinks();
		updateBody();
		return false;
	});

	$("#previous").click(function(){
		currentVersion = currentVersion - 1;
		updateLinks();
		updateBody();
		return false;
	});
});
</script>
<style>

	body {
		width: 1300px;
	}

	#container {
		width: 800px;
		margin: 0 auto;
	}

	#widget {
		width: 1300px;
	}

	#widgetBody{
		border: 3px solid #000;
	}

	#widgetBody div {
		float: left;
		/*padding:7px;*/
	}

	#codeZone {
		border-left: 1px solid #ccc;
		border-right: 1px solid #ccc;
		width: 500px;
		padding-left:20px;
	}

	#codeComments{
		width: 200px;
	}

	#widgetBody img {
		/*width: 350px;*/
		/*padding: 25px;*/
		padding: 0;
		margin: 0;
		width: 100%;
	}

	.navButton {
		float:left;
		padding: 3px;
		padding-right: 50px;
		background-color: #000;
		margin-right: 10px;
		color: #fff;
	}

	#progress {
		padding: 3px;
		background-color: #fff;
		color: #000;
		margin-right: 10px;
		float: left;
	}

	#widgetControls a {
		color: #fff;
		font-weight: bold;
		text-decoration: none;
	}

	#widgetTitle {
		float: right;
		text-align: right;

	}

	#widgetTitle h3{
		margin: 0;
		padding: 0;
	}
</style>
<head>
</head>
<body>
	<div id="container">
<h1 id="trackallthethings">Track All The Things</h1>

<h2 id="trackthebrightestpoint">Track the Brightest Point</h2>

<p><em>Probably the single simplest way to track an object with OpenCV is based on brightness. Brightness tracking is highly sensitive to lighting conditions and other changes in the scene, but it can work effectively in situations where you have a lot of control over the environment. In this section, we&#8217;ll use OpenCV&#8217;s <code>max()</code> function to track the brightest point in an image. We&#8217;ll also see how a variation of brightness tracking, applied to the individual color channels of an image, can be used for a crude form of color tracking.</em></p>

<p><iframe src="http://player.vimeo.com/video/69813654" width="500" height="281" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe></p>

<h3 id="videosummary">Video Summary</h3>

<ul>
<li>Brightness tracking is one of the simplest ways to track an object.</li>
<li>It&#8217;s very fragile (affected by changing lighting conditions) so if you want to use it you&#8217;ll need to control the environment</li>
<li>By default, our OpenCV object works off of a grayscale version of the input image.</li>
<li>Grayscale pixel values range from 0 (for black) to 255 (for white).</li>
<li>The pixel with the maximum value in this image will be the brightest point. (See the note about Luma as a measure of brightness below.)</li>
<li>If multiple pixels share the same maximum value (usually all white or all black if the image itself is all black), then the top-leftmost pixel will be selected.</li>
<li>We can make this dynamic by processing each new frame of a Capture object.</li>
<li>This technique works for any grayscale image.</li>
<li>OpenCV gives us the red, blue, and green channels of our image as individual grayscale images.</li>
<li>Finding the max of these individual channels will find the reddest, greenest, and bluest channel respectively.</li>
<li>This form of color tracking is very crude because of the limitations of RGB color space</li>
<li>See the Color Tracking in HSV Color Space for a more robust technique for tracking color.</li>
</ul>

<h4 id="luma:amoreaccuratemeasureofbrightness">Luma: A More Accurate Measure of Brightness</h4>

<p><a href="http://en.wikipedia.org/wiki/Luma_%28video%29">Luma</a> is a representation of the brightness of a pixel that matches human perception more accurately than its gray value, which is a simple average of the reg, green, and blue components. Luma can be calculated as an unequal combination of the red, green and blue components of the pixel according to the following formula: 0.2126*R + 0.7152*G + 0.0722*B. To use Luma for brightness tracking with our OpenCV image, you could iterate through the image and calculate the Luma value for each pixel, which would be slow. Or, you could use OpenCV&#8217;s <code><a href="http://docs.opencv.org/java/org/opencv/imgproc/Imgproc.html#cvtColor">Imgproc.cvtColor()</a></code> function in concert with <code>opencv.getBufferColor()</code> to convert the image to the <a href="https://en.wikipedia.org/wiki/Lab_color_space">LAB color space</a>, which includes Luma as one of its three channels.</p>

<p>This image demonstrates the comparison. The difference can be subtle. Click through to the larger size to make sure you see it. Look carefully at the right side of the image around the flashlight.</p>

<p><a href="http://www.flickr.com/photos/unavoidablegrain/9228785034/" title="Gray vs Luma by atduskgreg, on Flickr"><img src="http://farm3.staticflickr.com/2829/9228785034_39c665d9e9.jpg" width="500" height="358" alt="Gray vs Luma"></a></p>

<p>The code for this example (showing how to access the Luma channel) is here: <a href="https://github.com/atduskgreg/OpenCVPro/blob/library_rename/examples/LumaVsGray/LumaVsGray.pde">LumaVsGray.pde</a>.</p>

<p>In practice, the grayscale average of RGB is usually used due to its convenience.</p>

<h3 id="quiz">Quiz</h3>

<p>Q: What qualities of our input image could cause problems with brightness tracking: A) The presence of many glowing objects. B) Moving shadows cast by passersby. C) The auto-exposure on our camera triggering. D) All of the above.
<br /><em>A: D, all of the above.</em></p>

<p>Q: Which are easier to track with this version of color tracking: bright red or dark red objects?
<br/><em>A: Light red. Dark red objects will converge with the shadows in the scene where R, G, and B components are all near 0.</em></p>

<p>Q: What are some techniques we could use to prevent the brightest point from jumping around so much when tracking an object with this method?
<br /><em>A: 1) Lerp the x- and y-components of the brightest point between sequential frames. 2) Blur the image before finding the max to smooth over small differences between values. 3) Filter out large jumps in the position of the point, as they&#8217;re probably due to glitches rather than the continuous motion of the tracked object.</em></p>

<h3 id="code">Code</h3>

<h4 id="importantfunctions">Important Functions</h4>

<ul>
<li><code>opencv.max()</code> - Find the brightest point in the current gray image.</li>
<li><code>opencv.setBufferGray()</code> - Set the current gray image to another channel.</li>
<li><code>opencv.getBufferG()</code> - Get the green channel of the current image. Useful for passing to <code>opencv.setBufferGray()</code>.</li>
</ul>

<h4 id="browsethecode">Browse the Code</h4>

<ol>
<li>Capture image and load it into opencv.</li>
<li>Find and draw the point of max brightness.</li>
<li>Switch to Capture instead of a still image.</li>
<li>Use the green channel to track the greenest point.</li>
</ol>
</div>

	<div id="widget">
		<div id="widgetTitle"><h3>Title</hr></div>

		<div id="widgetControls">
			<div id="progress"></div>
			<div class="navButton" id="previous"><a href="#">Previous</a></div>
			<div class="navButton" id="next"><a href="#">Next</a></div>
		</div>

		<br style="clear:both" />
		<div id="widgetBody">
			<br style="clear:both;"/>
		</div>
	</div>
</body>
</html>
